<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>ÜV-Listen-Generator (FUTDB + FUT.GG)</title>
  <style>
    body{background:#0b0d10;color:#eaeef2;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Arial,sans-serif;line-height:1.35;margin:20px}
    h1{font-size:20px;margin:0 0 12px}
    .row{display:flex;gap:12px;flex-wrap:wrap;margin-bottom:12px}
    .card{background:#12161b;border:1px solid #1c2330;border-radius:10px;padding:12px}
    label{display:block;font-size:12px;color:#9fb0c3;margin-bottom:6px}
    input,select,button{background:#0f1318;color:#eaeef2;border:1px solid #1f2836;border-radius:8px;padding:9px 10px;font-size:14px}
    input:focus,select:focus,button:focus{outline:2px solid #3b82f6}
    button.primary{background:#f59e0b;border-color:#f59e0b;color:#121212;font-weight:600}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid #1d2635}
    th{font-size:12px;text-transform:uppercase;color:#9fb0c3;text-align:left}
    .muted{color:#9fb0c3;font-size:12px}
    .ok{color:#22c55e}
    .bad{color:#ef4444}
    .pill{font-size:12px;padding:3px 8px;border-radius:999px;border:1px solid #2a3445;background:#0f1318;color:#9fb0c3}
  </style>
</head>
<body>
  <h1>ÜV-Listen-Generator (Live via FUTDATABASE + FUT.GG)</h1>
  <div class="card">
    <div class="row">
      <div><label>Modus</label>
        <select id="mode">
          <option value="popular">Popular Player</option>
          <option value="played">Viel gespielt</option>
          <option value="fodder">Fodder (SBC)</option>
        </select>
      </div>
      <div><label>Plattform</label>
        <select id="platform">
          <option value="ps">Playstation</option>
          <option value="xbox">Xbox</option>
          <option value="pc">PC</option>
        </select>
      </div>
      <div><label>Budget (Coins)</label><input id="budget" type="number" value="100000"/></div>
      <div><label>Listengröße</label><input id="size" type="number" value="50"/></div>
      <div><label>OVR (min)</label><input id="ovrMin" type="number" value="78"/></div>
      <div><label>OVR (max)</label><input id="ovrMax" type="number" value="88"/></div>
      <div><label>BIN min</label><input id="binMin" type="number" value="1500"/></div>
      <div><label>BIN max</label><input id="binMax" type="number" value="60000"/></div>
      <div><label>Abschlag (%)</label><input id="discount" type="number" value="3"/></div>
      <div><label>Quelle</label>
        <select id="prefer">
          <option value="auto">FUTDB + Scraper (empfohlen)</option>
          <option value="futdb">Nur FUTDB-Preise</option>
          <option value="scraper">Nur FUT.GG-Scraper</option>
        </select>
      </div>
    </div>
    <div class="row">
      <button class="primary" id="btnBuild">Erstellen</button>
      <button id="btnTest">API testen</button>
      <span id="status" class="muted"></span>
    </div>
  </div>

  <div class="card" style="margin-top:12px">
    <table>
      <thead>
        <tr>
          <th>Spieler</th><th>Pos</th><th>OVR</th><th>BIN</th><th>Quelle</th>
          <th>Chemstyle</th><th>Kaufpreis</th><th>Verkaufspreis</th><th>Profit</th>
        </tr>
      </thead>
      <tbody id="rows"><tr><td colspan="9" class="muted">Noch keine Liste.</td></tr></tbody>
    </table>
  </div>

<script>
const $ = id => document.getElementById(id);
function fmt(n){ return (n||0).toLocaleString('de-DE'); }

$('btnTest').onclick = async () => {
  $('status').textContent = 'Teste API...';
  try{
    const r = await fetch('/api/futdb?type=test').then(r=>r.json());
    const ok = r.ok ? 'ok' : 'bad';
    $('status').innerHTML = `FUTDB: <span class="${ok}">${r.ok}</span> (base: ${r.base||'-'})`;
  }catch(e){ $('status').textContent = 'Test fehlgeschlagen.'; }
};

$('btnBuild').onclick = async () => {
  const qs = new URLSearchParams({
    mode: $('mode').value,
    platform: $('platform').value,
    size: $('size').value,
    ovrMin: $('ovrMin').value,
    ovrMax: $('ovrMax').value,
    binMin: $('binMin').value,
    binMax: $('binMax').value,
    discount: $('discount').value,
    prefer: $('prefer').value
  }).toString();

  $('status').textContent = 'Erzeuge Liste...';
  $('rows').innerHTML = `<tr><td colspan="9" class="muted">Erzeuge Liste...</td></tr>`;

  try{
    const data = await fetch('/api/uv-list?'+qs).then(r=>r.json());
    if (!data.ok) {
      $('status').innerHTML = `<span class="bad">Fehler:</span> ${data.error||'Unbekannt'}`;
      $('rows').innerHTML = `<tr><td colspan="9" class="muted">Keine Liste.</td></tr>`;
      return;
    }
    $('status').innerHTML = `Fertig. Preis-Treffer: <span class="ok">${data.priceHits}</span> — Einträge: ${data.items.length}`;

    if (!data.items.length) {
      $('rows').innerHTML = `<tr><td colspan="9" class="muted">Keine Deals im gesetzten Rahmen. Tipp: BIN-Bereich verbreitern (z. B. 1.5k–60k) oder OVR öffnen.</td></tr>`;
      return;
    }

    $('rows').innerHTML = data.items.map(it => `
      <tr>
        <td>${it.name}</td>
        <td>${it.pos||''}</td>
        <td>${it.ovr||''}</td>
        <td>${fmt(it.bin)}</td>
        <td><span class="pill">${it.src}</span></td>
        <td>${it.chem||''}</td>
        <td>${fmt(it.buy)}</td>
        <td>${fmt(it.sell)}</td>
        <td><strong>${fmt(it.profit)}</strong></td>
      </tr>`).join('');
  }catch(e){
    $('status').innerHTML = `<span class="bad">Fehlgeschlagen:</span> ${e.message}`;
    $('rows').innerHTML = `<tr><td colspan="9" class="muted">Keine Liste.</td></tr>`;
  }
};
</script>
</body>
</html>
