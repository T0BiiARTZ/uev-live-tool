<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>ÜV-Listen-Generator (FUTDATABASE + Scraper)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0f0f10;--panel:#161617;--ink:#f3f3f3;--muted:#9aa1a9;--line:#222;--accent:#f5a524;--good:#34d399;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
    .box{max-width:1150px;margin:0 auto;padding:18px}
    h2{margin:0 0 6px 0}
    .sub{color:var(--muted);margin-bottom:12px}
    .grid{display:grid;grid-template-columns:repeat(7,1fr);gap:10px}
    @media (max-width:1100px){.grid{grid-template-columns:1fr 1fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:#1b1c1f;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px}
    .btn{border:1px solid #3a3a3a;background:#1f1f20;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#111;border-color:#b77d10;font-weight:700}
    table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden;margin-top:12px}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    thead th{background:#121314;color:#c8cbd0}
    .status{margin:6px 0 10px 0;color:var(--muted)}
    .ok{color:var(--good)} .err{color:var(--bad)}
  </style>
</head>
<body>
  <div class="box">
    <h2>ÜV-Listen-Generator (Live via FUTDATABASE + FUT.GG Scraper)</h2>
    <div class="sub">EA-Tax 5 %, Zielprofit ~1.000, Mindestprofit 800, Rundung 100 • Buy = BIN – Abschlag %</div>

    <div id="status" class="status">Bereit.</div>

    <div class="grid">
      <div class="card">
        <label>Modus</label>
        <select id="mode">
          <option value="fodder">Fodder (SBC-Futter)</option>
          <option value="popular">Popular Player</option>
          <option value="played">Viel gespielt</option>
        </select>
      </div>
      <div class="card">
        <label>Plattform</label>
        <select id="platform">
          <option value="ps">Playstation</option>
          <option value="xbox">Xbox</option>
          <option value="pc">PC</option>
        </select>
      </div>
      <div class="card">
        <label>Budget (Coins)</label>
        <input type="number" id="budget" value="100000" min="1000" step="1000" />
      </div>
      <div class="card">
        <label>Listengröße</label>
        <input type="number" id="size" value="50" min="1" max="300" />
      </div>
      <div class="card">
        <label>OVR (min-max)</label>
        <div style="display:flex;gap:8px">
          <input type="number" id="ovrMin" value="80" min="50" max="99" />
          <input type="number" id="ovrMax" value="84" min="50" max="99" />
        </div>
      </div>
      <div class="card">
        <label>BIN-Bereich (min-max)</label>
        <div style="display:flex;gap:8px">
          <input type="number" id="binMin" value="2000" min="0" step="100" />
          <input type="number" id="binMax" value="20000" min="0" step="100" />
        </div>
      </div>
      <div class="card">
        <label>Abschlag (%)</label>
        <input type="number" id="discount" value="3" min="0" max="30" step="0.5" />
      </div>
    </div>

    <div style="display:flex;gap:10px;margin:8px 0 12px">
      <button class="btn primary" id="btnMake">Erstellen</button>
      <button class="btn" id="btnTest">API testen</button>
    </div>

    <table>
      <thead>
        <tr>
          <th>Spieler</th><th>Pos</th><th>OVR</th><th>BIN</th>
          <th>Chemstyle</th><th>Kaufpreis</th><th>Verkaufspreis</th><th>Profit</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="8" style="color:#9aa1a9">Noch keine Liste.</td></tr>
      </tbody>
    </table>
  </div>

<script>
const statusEl = document.getElementById('status');
function setStatus(msg, ok=null){ statusEl.textContent = msg; statusEl.className = 'status' + (ok===true?' ok':(ok===false?' err':'')); }
function chemFor(pos){
  const p=(pos||'').toUpperCase();
  const atk=/ST|CF|LW|RW|LM|RM|CAM|CM|RF|LF/.test(p), def=/CB|LB|RB|LWB|RWB|CDM/.test(p);
  if(atk) return 'Hunter / Engine / Finisher';
  if(def) return (p==='CB'||p==='CDM') ? 'Shadow / Anchor' : 'Shadow';
  return p==='GK' ? 'Basic' : 'Basic / Engine';
}
function roundTo(v,step){ return Math.round(v/step)*step; }
async function api(path){ const r=await fetch(path,{cache:'no-store'}); const t=await r.text(); try{ return JSON.parse(t);}catch{return{raw:t}}; }

async function testAPI(){
  try{
    setStatus('Teste API…');
    const futdb=await api('/api/futdb?type=test');
    const pop=await api('/api/popular-scrape?limit=10');
    const price=await api('/api/price-scrape?name=Kylian%20Mbappe&platform=ps');
    alert('FUTDB: '+JSON.stringify(futdb)+'\nPOPULAR: '+JSON.stringify(pop)+'\nSCRAPER: '+JSON.stringify(price));
    setStatus('API-Test abgeschlossen.', true);
  }catch(e){ alert('API-Fehler: '+e.message); setStatus('API-Fehler: '+e.message,false); }
}

// Kandidaten via FUTDB (mehrere Seiten)
async function fetchPlayersPaged(targetCount){
  const batch=[]; let page=1; const limit=200; const maxPages=5;
  while(batch.length < targetCount*3 && page<=maxPages){
    const j=await api(`/api/futdb?type=players&page=${page}&limit=${limit}`);
    const arr=(j&&(j.items||j.data))?(j.items||j.data):[];
    batch.push(...arr);
    if(arr.length<limit) break;
    page++;
  }
  return batch;
}

// FODDER-Heuristik: hohe OVR, nicht „Meta“-Flügel/Striker
function isFodder(p, oMin, oMax){
  const o=+(p.rating||p.ovr||0);
  const pos=(p.position||'').toUpperCase();
  const notMeta = /GK|CB|LB|RB|LWB|RWB|CDM|CM/.test(pos); // „langsame“/SBC-geeignete Positionen
  return o>=Math.max(82,oMin) && o<=Math.max(oMin,oMax) && notMeta;
}

// META/Popular Positionen (für „popular/played“ Fallbacks)
function goodMetaPos(pos){ return /ST|CF|LW|RW|LM|RM|CAM|CM|CB|LB|RB/.test((pos||'').toUpperCase()); }

async function createList(){
  const mode = document.getElementById('mode').value;
  const plat = document.getElementById('platform').value;
  const budget = +document.getElementById('budget').value||0;
  const size = +document.getElementById('size').value||0;
  const ovrMin = +document.getElementById('ovrMin').value||0;
  const ovrMax = +document.getElementById('ovrMax').value||99;
  const binMin = +document.getElementById('binMin').value||0;
  const binMax = +document.getElementById('binMax').value||1e9;
  const discount = +document.getElementById('discount').value||0;
  const tbody = document.getElementById('tbody');

  tbody.innerHTML = '<tr><td colspan="8">Erzeuge Liste…</td></tr>';
  setStatus('Sammle Kandidaten…');

  try{
    let candidates = [];

    if (mode === 'popular' || mode === 'played'){
      // Scrape beliebte/oft gespielte Spieler
      const pop = await api('/api/popular-scrape?limit='+(size*2));
      candidates = (pop && pop.items) ? pop.items.map(x=>({ name:x.name, position:x.pos||'', rating:x.ovr })) : [];
      if (!candidates.length){
        // Fallback über FUTDB: grobe Meta-Filter
        const pool = await fetchPlayersPaged(size);
        candidates = pool.filter(p=>{
          const o=+(p.rating||0);
          return o>=Math.max(78,ovrMin) && o<=Math.min(88,ovrMax) && goodMetaPos(p.position);
        }).slice(0, size*2);
      }
    } else {
      // FODDER
      const pool = await fetchPlayersPaged(size);
      candidates = pool.filter(p=> isFodder(p, ovrMin, ovrMax) ).slice(0, size*3);
      if(!candidates.length) candidates = pool.slice(0, size*3);
    }

    if(!candidates.length){ setStatus('Keine Kandidaten gefunden.', false); tbody.innerHTML='<tr><td colspan="8">Keine Kandidaten.</td></tr>'; return; }

    const rows=[];

    for (const p of candidates){
      if (rows.length >= size) break;

      const name = p.name || p.fullName || p.commonName || '-';
      const pos  = p.position || '';
      const ovr  = +(p.rating||p.ovr||0) || '';

      // Preis: 1) FUTDB (falls Plan) 2) Scraper
      let bin = null;
      try {
        if (p.id) {
          const pj = await api(`/api/futdb?type=price&playerId=${encodeURIComponent(p.id)}&platform=${plat}`);
          if (pj && (pj.lowestBin||pj.bin||pj.price)) bin = pj.lowestBin||pj.bin||pj.price;
        }
      }catch{}

      if (bin===null){
        try{
          const sj = await api(`/api/price-scrape?name=${encodeURIComponent(name)}&platform=${plat}`);
          if (sj && sj.bin) bin = sj.bin;
        }catch{}
      }

      if (bin==null || !isFinite(bin) || bin<=0) continue;
      if (bin < binMin || bin > binMax) continue;
      if (bin > budget) continue;

      const buy = roundTo(bin*(1 - discount/100), 100);
      const targetProfit = 1000; // ~1k nach Tax
      const sell = roundTo((buy + targetProfit) / 0.95, 100);
      const profit = Math.floor(sell*0.95 - buy);
      if (profit < 800) continue;

      // Fodder: leicht bevorzugen, wenn Name/Pos darauf hindeuten
      rows.push({
        name, pos, ovr: (ovr || ''), bin, chem: chemFor(pos),
        buy, sell, profit
      });
    }

    rows.sort((a,b)=> b.profit - a.profit);

    const tbodyEl = tbody;
    tbodyEl.innerHTML='';
    if(!rows.length){
      tbodyEl.innerHTML = '<tr><td colspan="8">Keine Deals im gesetzten Rahmen. Tipp: BIN-Bereich etwas weiten oder Abschlag ↘︎.</td></tr>';
      setStatus('Keine Deals gefunden.', false);
      return;
    }

    for (const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.name}</td>
        <td>${r.pos||'—'}</td>
        <td>${r.ovr||'—'}</td>
        <td>${r.bin.toLocaleString('de-DE')}</td>
        <td>${r.chem}</td>
        <td>${r.buy.toLocaleString('de-DE')}</td>
        <td>${r.sell.toLocaleString('de-DE')}</td>
        <td>+${r.profit.toLocaleString('de-DE')}</td>`;
      tbodyEl.appendChild(tr);
    }
    setStatus('Fertig.', true);
  }catch(e){
    setStatus('Fehler: '+e.message, false);
    tbody.innerHTML = '<tr><td colspan="8">Fehler beim Erstellen.</td></tr>';
  }
}

document.getElementById('btnTest').addEventListener('click', testAPI);
document.getElementById('btnMake').addEventListener('click', createList);
</script>
</body>
</html>
