<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>ÜV-Listen-Generator (FUTDATABASE + Scraper)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0f0f10;--panel:#161617;--ink:#f3f3f3;--muted:#9aa1a9;--line:#222;--accent:#f5a524;--good:#34d399;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
    .box{max-width:1100px;margin:0 auto;padding:18px}
    h2{margin:0 0 6px 0}
    .sub{color:var(--muted);margin-bottom:10px}
    .row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:12px 0}
    @media (max-width:900px){.row{grid-template-columns:1fr 1fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:#1b1c1f;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px}
    .btn{border:1px solid #3a3a3a;background:#1f1f20;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#111;border-color:#b77d10;font-weight:700}
    table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    thead th{background:#121314;color:#c8cbd0}
    .status{margin:6px 0 10px 0;color:var(--muted)}
    .ok{color:var(--good)} .err{color:var(--bad)}
  </style>
</head>
<body>
  <div class="box">
    <h2>ÜV-Listen-Generator (Live via FUTDATABASE + FUT.GG Scraper)</h2>
    <div class="sub">EA-Tax 5 %, Zielprofit ~1.000, Mindestprofit 800, Rundung 100 • Buy = BIN – Abschlag %</div>

    <div id="status" class="status">Bereit.</div>

    <div class="row">
      <div class="card">
        <label>Plattform</label>
        <select id="platform">
          <option value="ps">Playstation</option>
          <option value="xbox">Xbox</option>
          <option value="pc">PC</option>
        </select>
      </div>
      <div class="card">
        <label>Budget (Coins)</label>
        <input type="number" id="budget" value="100000" min="1000" step="1000" />
      </div>
      <div class="card">
        <label>Listengröße</label>
        <input type="number" id="size" value="100" min="1" max="300" />
      </div>
      <div class="card">
        <label>Marktpreis-Abschlag (%)</label>
        <input type="number" id="discount" value="3" min="0" max="30" step="0.5" />
      </div>
      <div class="card" style="display:flex;align-items:end;gap:8px">
        <button class="btn primary" id="btnMake" style="flex:1">Erstellen</button>
        <button class="btn" id="btnTest">API testen</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Spieler</th><th>Pos</th><th>OVR</th><th>BIN</th>
          <th>Chemstyle</th><th>Kaufpreis</th><th>Verkaufspreis</th><th>Profit</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="8" style="color:#9aa1a9">Noch keine Liste.</td></tr>
      </tbody>
    </table>
  </div>

<script>
const statusEl = document.getElementById('status');
function setStatus(msg, ok=null){ statusEl.textContent = msg; statusEl.className = 'status' + (ok===true?' ok':(ok===false?' err':'')); }
function chemFor(pos){
  const p=(pos||'').toUpperCase();
  const atk=/ST|CF|LW|RW|LM|RM|CAM|CM|RF|LF/.test(p), def=/CB|LB|RB|LWB|RWB|CDM|GK/.test(p);
  if(atk) return 'Hunter / Engine / Finisher';
  if(def) return (p==='CB'||p==='CDM') ? 'Shadow / Anchor' : 'Shadow';
  return 'Basic / Engine';
}
function roundTo(v,step){ return Math.round(v/step)*step; }
async function api(path){
  const r = await fetch(path,{cache:'no-store'});
  const t = await r.text(); try { return JSON.parse(t); } catch { return {raw:t}; }
}

// FUTDB ok? Scraper ok?
async function testAPI(){
  try{
    setStatus('Teste API…');
    const futdb = await api('/api/futdb?type=test');
    const scrape = await api('/api/price-scrape?name=Kylian%20Mbappe&platform=ps');
    alert('FUTDATABASE: ' + JSON.stringify(futdb) + '\nSCRAPER: ' + JSON.stringify(scrape));
    setStatus('API-Test abgeschlossen.', true);
  }catch(e){
    alert('API-Fehler: ' + e.message);
    setStatus('API-Fehler: ' + e.message, false);
  }
}

// Kandidaten: großzüger (OVR 75–86, sinnvolle Positionen). Fallback: nimm einfach die ersten N.
function looksMeta(p){
  const o = +(p.rating||p.ovr||0);
  const pos = (p.position||'').toUpperCase();
  const okPos = /ST|CF|LW|RW|LM|RM|CAM|CM|CDM|CB|LB|RB|GK/.test(pos);
  return o>=75 && o<=86 && okPos;
}

async function createList(){
  const plat = document.getElementById('platform').value;
  const budget = +document.getElementById('budget').value||0;
  const size = +document.getElementById('size').value||0;
  const discount = +document.getElementById('discount').value||0;
  const tbody = document.getElementById('tbody');

  tbody.innerHTML = '<tr><td colspan="8">Erzeuge Liste…</td></tr>';
  setStatus('Lade Spieler (Proxy)…');

  try{
    const j = await api('/api/futdb?type=players');
    const all = (j && (j.items||j.data)) ? (j.items||j.data) : [];
    if(!all.length){ setStatus('Spieler-Endpoint leer.'); return; }

    let cand = all.filter(looksMeta);
    if (!cand.length) cand = all.slice();               // Fallback: nimm alle
    cand = cand.slice(0, Math.min(cand.length, size*3 || 150)); // etwas Überhang

    const rows = [];

    // Preis + Buy/Sell/Profit holen/berechnen
    for (const p of cand){
      // 1) FUTDB Preis (wenn Plan erlaubt)
      let bin = null;
      try {
        const pj = await api(`/api/futdb?type=price&playerId=${encodeURIComponent(p.id||p.playerId)}&platform=${plat}`);
        if (pj && (pj.lowestBin||pj.bin||pj.price)) bin = pj.lowestBin||pj.bin||pj.price;
      } catch {}

      // 2) Scraper Fallback
      if (bin===null){
        try{
          const sj = await api(`/api/price-scrape?name=${encodeURIComponent(p.name||'')}&platform=${plat}`);
          if (sj && sj.bin) bin = sj.bin;
        }catch{}
      }

      const hasPrice = bin!==null && isFinite(bin) && bin>0;
      let buy=null, sell=null, profit=null;
      if (hasPrice){
        buy = roundTo(bin*(1 - discount/100), 100);
        const targetProfit = 1000; // nach Tax ~1k
        sell = roundTo((buy + targetProfit) / 0.95, 100);
        profit = Math.floor(sell*0.95 - buy);
        if (bin>budget || profit<800) continue; // nur sinnvolle Deals
      }

      rows.push({
        name:p.name||'-', pos:p.position||'-', ovr:(p.rating||p.ovr||'-'),
        bin: hasPrice?bin:null,
        chem: chemFor(p.position),
        buy, sell, profit
      });

      if (rows.length >= size) break;
    }

    // Sortiere nach höchstem Profit (Preislose kommen nach hinten)
    rows.sort((a,b)=>{
      if (a.profit==null && b.profit==null) return 0;
      if (a.profit==null) return 1;
      if (b.profit==null) return -1;
      return b.profit - a.profit;
    });

    // Tabelle ausgeben
    tbody.innerHTML='';
    if(!rows.length){
      tbody.innerHTML = '<tr><td colspan="8">Keine Ergebnisse. (Preisquelle liefert nichts oder Filter zu streng.)</td></tr>';
      setStatus('Keine Deals gefunden.', false);
      return;
    }
    for (const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.name}</td>
        <td>${r.pos}</td>
        <td>${r.ovr}</td>
        <td>${r.bin!=null ? r.bin.toLocaleString('de-DE') : '—'}</td>
        <td>${r.chem}</td>
        <td>${r.buy!=null ? r.buy.toLocaleString('de-DE') : '—'}</td>
        <td>${r.sell!=null ? r.sell.toLocaleString('de-DE') : '—'}</td>
        <td>${r.profit!=null ? ('+'+r.profit.toLocaleString('de-DE')) : '—'}</td>
      `;
      tbody.appendChild(tr);
    }
    setStatus('Fertig.', true);
  }catch(e){
    setStatus('Fehler: '+e.message, false);
    tbody.innerHTML = '<tr><td colspan="8">Fehler beim Erstellen.</td></tr>';
  }
}

document.getElementById('btnTest').addEventListener('click', testAPI);
document.getElementById('btnMake').addEventListener('click', createList);
</script>
</body>
</html>
<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>ÜV-Listen-Generator (FUTDATABASE + Scraper)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{--bg:#0f0f10;--panel:#161617;--ink:#f3f3f3;--muted:#9aa1a9;--line:#222;--accent:#f5a524;--good:#34d399;--bad:#ef4444}
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.5 system-ui,Segoe UI,Roboto,Inter,Arial}
    .box{max-width:1100px;margin:0 auto;padding:18px}
    h2{margin:0 0 6px 0}
    .sub{color:var(--muted);margin-bottom:10px}
    .row{display:grid;grid-template-columns:repeat(5,1fr);gap:10px;margin:12px 0}
    @media (max-width:900px){.row{grid-template-columns:1fr 1fr}}
    .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:10px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    input,select{width:100%;background:#1b1c1f;border:1px solid var(--line);color:var(--ink);border-radius:10px;padding:10px}
    .btn{border:1px solid #3a3a3a;background:#1f1f20;color:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    .btn.primary{background:var(--accent);color:#111;border-color:#b77d10;font-weight:700}
    table{width:100%;border-collapse:collapse;background:var(--panel);border:1px solid var(--line);border-radius:12px;overflow:hidden}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left}
    thead th{background:#121314;color:#c8cbd0}
    .status{margin:6px 0 10px 0;color:var(--muted)}
    .ok{color:var(--good)} .err{color:var(--bad)}
  </style>
</head>
<body>
  <div class="box">
    <h2>ÜV-Listen-Generator (Live via FUTDATABASE + FUT.GG Scraper)</h2>
    <div class="sub">EA-Tax 5 %, Zielprofit ~1.000, Mindestprofit 800, Rundung 100 • Buy = BIN – Abschlag %</div>

    <div id="status" class="status">Bereit.</div>

    <div class="row">
      <div class="card">
        <label>Plattform</label>
        <select id="platform">
          <option value="ps">Playstation</option>
          <option value="xbox">Xbox</option>
          <option value="pc">PC</option>
        </select>
      </div>
      <div class="card">
        <label>Budget (Coins)</label>
        <input type="number" id="budget" value="100000" min="1000" step="1000" />
      </div>
      <div class="card">
        <label>Listengröße</label>
        <input type="number" id="size" value="100" min="1" max="300" />
      </div>
      <div class="card">
        <label>Marktpreis-Abschlag (%)</label>
        <input type="number" id="discount" value="3" min="0" max="30" step="0.5" />
      </div>
      <div class="card" style="display:flex;align-items:end;gap:8px">
        <button class="btn primary" id="btnMake" style="flex:1">Erstellen</button>
        <button class="btn" id="btnTest">API testen</button>
      </div>
    </div>

    <table>
      <thead>
        <tr>
          <th>Spieler</th><th>Pos</th><th>OVR</th><th>BIN</th>
          <th>Chemstyle</th><th>Kaufpreis</th><th>Verkaufspreis</th><th>Profit</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="8" style="color:#9aa1a9">Noch keine Liste.</td></tr>
      </tbody>
    </table>
  </div>

<script>
const statusEl = document.getElementById('status');
function setStatus(msg, ok=null){ statusEl.textContent = msg; statusEl.className = 'status' + (ok===true?' ok':(ok===false?' err':'')); }
function chemFor(pos){
  const p=(pos||'').toUpperCase();
  const atk=/ST|CF|LW|RW|LM|RM|CAM|CM|RF|LF/.test(p), def=/CB|LB|RB|LWB|RWB|CDM|GK/.test(p);
  if(atk) return 'Hunter / Engine / Finisher';
  if(def) return (p==='CB'||p==='CDM') ? 'Shadow / Anchor' : 'Shadow';
  return 'Basic / Engine';
}
function roundTo(v,step){ return Math.round(v/step)*step; }
async function api(path){
  const r = await fetch(path,{cache:'no-store'});
  const t = await r.text(); try { return JSON.parse(t); } catch { return {raw:t}; }
}

// FUTDB ok? Scraper ok?
async function testAPI(){
  try{
    setStatus('Teste API…');
    const futdb = await api('/api/futdb?type=test');
    const scrape = await api('/api/price-scrape?name=Kylian%20Mbappe&platform=ps');
    alert('FUTDATABASE: ' + JSON.stringify(futdb) + '\nSCRAPER: ' + JSON.stringify(scrape));
    setStatus('API-Test abgeschlossen.', true);
  }catch(e){
    alert('API-Fehler: ' + e.message);
    setStatus('API-Fehler: ' + e.message, false);
  }
}

// Kandidaten: großzüger (OVR 75–86, sinnvolle Positionen). Fallback: nimm einfach die ersten N.
function looksMeta(p){
  const o = +(p.rating||p.ovr||0);
  const pos = (p.position||'').toUpperCase();
  const okPos = /ST|CF|LW|RW|LM|RM|CAM|CM|CDM|CB|LB|RB|GK/.test(pos);
  return o>=75 && o<=86 && okPos;
}

async function createList(){
  const plat = document.getElementById('platform').value;
  const budget = +document.getElementById('budget').value||0;
  const size = +document.getElementById('size').value||0;
  const discount = +document.getElementById('discount').value||0;
  const tbody = document.getElementById('tbody');

  tbody.innerHTML = '<tr><td colspan="8">Erzeuge Liste…</td></tr>';
  setStatus('Lade Spieler (Proxy)…');

  try{
    const j = await api('/api/futdb?type=players');
    const all = (j && (j.items||j.data)) ? (j.items||j.data) : [];
    if(!all.length){ setStatus('Spieler-Endpoint leer.'); return; }

    let cand = all.filter(looksMeta);
    if (!cand.length) cand = all.slice();               // Fallback: nimm alle
    cand = cand.slice(0, Math.min(cand.length, size*3 || 150)); // etwas Überhang

    const rows = [];

    // Preis + Buy/Sell/Profit holen/berechnen
    for (const p of cand){
      // 1) FUTDB Preis (wenn Plan erlaubt)
      let bin = null;
      try {
        const pj = await api(`/api/futdb?type=price&playerId=${encodeURIComponent(p.id||p.playerId)}&platform=${plat}`);
        if (pj && (pj.lowestBin||pj.bin||pj.price)) bin = pj.lowestBin||pj.bin||pj.price;
      } catch {}

      // 2) Scraper Fallback
      if (bin===null){
        try{
          const sj = await api(`/api/price-scrape?name=${encodeURIComponent(p.name||'')}&platform=${plat}`);
          if (sj && sj.bin) bin = sj.bin;
        }catch{}
      }

      const hasPrice = bin!==null && isFinite(bin) && bin>0;
      let buy=null, sell=null, profit=null;
      if (hasPrice){
        buy = roundTo(bin*(1 - discount/100), 100);
        const targetProfit = 1000; // nach Tax ~1k
        sell = roundTo((buy + targetProfit) / 0.95, 100);
        profit = Math.floor(sell*0.95 - buy);
        if (bin>budget || profit<800) continue; // nur sinnvolle Deals
      }

      rows.push({
        name:p.name||'-', pos:p.position||'-', ovr:(p.rating||p.ovr||'-'),
        bin: hasPrice?bin:null,
        chem: chemFor(p.position),
        buy, sell, profit
      });

      if (rows.length >= size) break;
    }

    // Sortiere nach höchstem Profit (Preislose kommen nach hinten)
    rows.sort((a,b)=>{
      if (a.profit==null && b.profit==null) return 0;
      if (a.profit==null) return 1;
      if (b.profit==null) return -1;
      return b.profit - a.profit;
    });

    // Tabelle ausgeben
    tbody.innerHTML='';
    if(!rows.length){
      tbody.innerHTML = '<tr><td colspan="8">Keine Ergebnisse. (Preisquelle liefert nichts oder Filter zu streng.)</td></tr>';
      setStatus('Keine Deals gefunden.', false);
      return;
    }
    for (const r of rows){
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${r.name}</td>
        <td>${r.pos}</td>
        <td>${r.ovr}</td>
        <td>${r.bin!=null ? r.bin.toLocaleString('de-DE') : '—'}</td>
        <td>${r.chem}</td>
        <td>${r.buy!=null ? r.buy.toLocaleString('de-DE') : '—'}</td>
        <td>${r.sell!=null ? r.sell.toLocaleString('de-DE') : '—'}</td>
        <td>${r.profit!=null ? ('+'+r.profit.toLocaleString('de-DE')) : '—'}</td>
      `;
      tbody.appendChild(tr);
    }
    setStatus('Fertig.', true);
  }catch(e){
    setStatus('Fehler: '+e.message, false);
    tbody.innerHTML = '<tr><td colspan="8">Fehler beim Erstellen.</td></tr>';
  }
}

document.getElementById('btnTest').addEventListener('click', testAPI);
document.getElementById('btnMake').addEventListener('click', createList);
</script>
</body>
</html>
