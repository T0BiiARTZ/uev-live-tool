<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <title>ÜV-Listen-Generator (Live via FUTDATABASE + Scraper)</title>
  <style>
    body { background: #111; color: #fff; font-family: Arial, sans-serif; }
    .box { margin: 10px; padding: 10px; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { padding: 8px; border-bottom: 1px solid #444; text-align: left; }
    th { background: #222; }
    button { background: orange; border: none; padding: 8px 12px; cursor: pointer; }
  </style>
</head>
<body>
  <h2>ÜV-Listen-Generator (Live via FUTDATABASE)</h2>
  <p>EA-Tax 5 %, Zielprofit ~1.000, Mindestprofit 800, Rundung 100 • Buy = BIN – Abschlag %</p>

  <div class="box">
    Plattform: 
    <select id="platform">
      <option value="ps">Playstation</option>
      <option value="xbox">Xbox</option>
      <option value="pc">PC</option>
    </select>
    Budget (Coins): <input type="number" id="budget" value="100000" />
    Listengröße: <input type="number" id="limit" value="10" />
    Marktpreis-Abschlag (%): <input type="number" id="discount" value="3" />
    <button onclick="generate()">Erstellen</button>
    <button onclick="testApi()">API testen</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Spieler</th><th>Pos</th><th>OVR</th><th>BIN</th>
        <th>Chemstyle</th><th>Kaufpreis</th><th>Verkaufspreis</th><th>Profit</th>
      </tr>
    </thead>
    <tbody id="list"></tbody>
  </table>

  <script>
    const API_BASE = "https://api.futdatabase.com/api";
    const SCRAPER = "/api/price-scrape"; // dein Vercel-Endpunkt

    async function testApi() {
      const futdb = { ok: !!API_BASE, base: API_BASE };
      const scrape = await fetch(`${SCRAPER}?name=Messi&platform=ps`).then(r=>r.json()).catch(()=>({bin:null}));
      alert("FUTDATABASE: " + JSON.stringify(futdb) + "\nSCRAPER: " + JSON.stringify(scrape));
    }

    async function generate() {
      const plat = document.getElementById("platform").value;
      const budget = +document.getElementById("budget").value;
      const limit = +document.getElementById("limit").value;
      const discount = +document.getElementById("discount").value;

      const list = document.getElementById("list");
      list.innerHTML = "<tr><td colspan=8>Erzeuge Liste...</td></tr>";

      // 1) Spieler aus FUTDATABASE ziehen
      const res = await fetch(`${API_BASE}/players?limit=${limit}`);
      const data = await res.json();

      list.innerHTML = "";

      for (const p of data.items || []) {
        // 2) Live BIN via Scraper
        const s = await fetch(`${SCRAPER}?name=${encodeURIComponent(p.name)}&platform=${plat}`).then(r=>r.json()).catch(()=>({bin:null}));
        const bin = s.bin || null;

        let buy = bin ? Math.floor(bin * (1 - discount / 100)) : null;
        let sell = bin || null;
        let profit = (sell && buy) ? Math.floor((sell * 0.95) - buy) : null;

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${p.name}</td>
          <td>${p.position}</td>
          <td>${p.rating}</td>
          <td>${bin ? bin.toLocaleString() : "-"}</td>
          <td>${p.position === "ST" ? "Hunter / Engine / Finisher" : "Shadow / Anchor"}</td>
          <td>${buy ? buy.toLocaleString() : "-"}</td>
          <td>${sell ? sell.toLocaleString() : "-"}</td>
          <td>${profit ? profit.toLocaleString() : "-"}</td>
        `;
        list.appendChild(tr);
      }
    }
  </script>
</body>
</html>
